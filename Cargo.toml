[package]
name = "vertex"
version = "0.1.0"
authors = ["f1shl3gs"]
edition = "2021"

exclude = [
    "tests/fixtures"
]

# [profile.release]
# lto = true

[workspace]
members = [
    "lib/buffers",
    "lib/event",
    "lib/procfs",
    "lib/file-source",
    "lib/internal",
    "lib/prometheus",
    "lib/testify",
    "lib/tail",
    "lib/log_schema",
    "lib/tracing-limit",
    "lib/humanize",
    "lib/sysinfo"
]

[features]
default = [
    # common
    "disk-buffer",
    "listenfd",
    "sources",
    "transforms",
    "sinks",
    # extensions
    "extensions-pprof",
    # "extensions-jemalloc"
]

target-x86_64-unknown-linux-musl = [
    "disk-buffer",
    "sinks",
    "sources",
    "transforms",
    "rdkafka-cmake",
    "unix",
    "openssl/vendored",
    # For some reason, once we enable "sources-kafka" the build will fail,
    # and it looks like cross cannot link openss. The confused part is that
    # "rdkafka" is already built due to "sinks-kafka" is enabled.
    #
    # Vertex is not ready for production yet, all i can do now is waiting,
    # maybe new version of "rdkafka" or "openssl" can fix this.
    # "sources-kafka",
    "rdkafka/gssapi-vendored",
    "rdkafka/ssl-vendored",
]

target-x86_64-unknown-linux-gnu = [
    "disk-buffer",
    "sinks",
    "sources",
    "transforms",
    "rdkafka-cmake",
    "unix",
    "openssl/vendored",
    "rdkafka/gssapi-vendored",
    "sources-kafka"
]

# Integration tests
integration-tests = []

integration-tests-nginx_stub = []
integration-tests-redis = []
integration-tests-mysql = []
integration-tests-zookeeper = []
integration-tests-kafka = []
integration-tests-loki = []
integration-tests-haproxy = []
integration-tests-memcached = []
integration-tests-ntp = []
integration-tests-prometheus_scrape = []
integration-tests-prometheus_exporter = []

# Common
disk-buffer = []
tokio-console = [
    "console-subscriber"
]

# Allocator
allocator-mimalloc = ["mimalloc"]
allocator-jemalloc = ["jemallocator"]

# Sources
sources = [
    "sources-bind",
    "sources-generator",
    "sources-node_metrics",
    "sources-ntp",
    # "sources-kafka",
    "sources-kafka_metrics",
    "sources-kmsg",
    "sources-selfstat",
    "sources-journald",
    "sources-internal_metrics",
    "sources-internal_logs",
    "sources-redis",
    "sources-pulsar",
    "sources-prometheus_scrape",
    "sources-prometheus_remote_write",
    "sources-nginx_stub",
    "sources-zookeeper",
    "sources-haproxy",
    "sources-memcached",
    "sources-fluentd",
    "sources-syslog",
    "sources-tail",
    "sources-libvirt",
    "sources-mysqld",
    "sources-nvidia_smi",
    "sources-mongodb",
    "sources-elasticsearch"
]

sources-bind = []
sources-generator = []
sources-node_metrics = ["libc", "netlink-packet-sock-diag", "netlink-sys", "rtnetlink"]
sources-ntp = ["rsntp/tokio", "rsntp/async"]
sources-kafka = ["rdkafka"]
sources-kafka_metrics = ["rdkafka"]
sources-kmsg = []
sources-selfstat = ["libc"]
sources-journald = []
sources-internal_metrics = []
sources-internal_logs = []
sources-redis = ["redis"]
sources-pulsar = ["pulsar"]
sources-prometheus_scrape = []
sources-prometheus_remote_write = []
sources-nginx_stub = []
sources-zookeeper = []
sources-haproxy = []
sources-memcached = []
sources-fluentd = []
sources-syslog = []
sources-tail = []
sources-libvirt = []
sources-mysqld = ["sqlx"]
sources-nvidia_smi = ["serde-xml-rs"]
sources-mongodb = ["mongodb/tokio-runtime"]
sources-elasticsearch = []

# transforms
transforms = [
    "transforms-add_tags",
    "transforms-add_fields",
    "transforms-cardinality",
    "transforms-sample"
]
transforms-add_tags = []
transforms-add_fields = []
transforms-cardinality = []
transforms-sample = ["seahash"]

# sinks
sinks = [
    "sinks-prometheus_exporter",
    "sinks-stdout",
    "sinks-blackhole",
    "sinks-kafka",
    "sinks-pulsar",
    "sinks-elasticsearch",
    "sinks-loki",
    "sinks-vertex",
    "sinks-clickhouse",
]

sinks-prometheus_exporter = []
sinks-stdout = []
sinks-blackhole = []
sinks-kafka = ["rdkafka"]
sinks-pulsar = ["pulsar"]
sinks-elasticsearch = []
sinks-loki = []
sinks-vertex = []
sinks-clickhouse = []

# extensions
extensions-pprof = ["pprof/flamegraph"]
extensions-jemalloc = ["jemallocator", "jemalloc-ctl", "jemalloc-sys"]

# Enables `rdkafka` dependency.
# This feature is more portable, but requires `cmake` as build dependency. Use it if `rdkafka-plain` doesn't work.
# The `sasl` feature has to be added because of the limitations of `librdkafka` build scripts for `cmake`.
rdkafka-cmake = ["rdkafka", "rdkafka/cmake_build"]

# Enables features that work only on systems providing `cfg(unix)`
unix = []

# These are **very** useful on Cross compilations!
# vendor-all = ["vendor-openssl"]
# vendor-sasl = ["rdkafka/gssapi-vendored"]
# vendor-openssl = ["openssl/vendored"]

[[bench]]
name = "loki"
harness = false
path = "benches/loki.rs"

[[bench]]
name = "hwmon_gather"
harness = false
path = "benches/node_source_hwmon.rs"

[[bench]]
name = "haproxy"
harness = false
path = "benches/haproxy.rs"

[target.'cfg(unix)'.dependencies]
atty = "0.2.14"
nix = ">=0.22.2"

[build-dependencies]
prost-build = { version = "0.9" }

[dev-dependencies]
tokio = { version = "1.14.0", features = ["test-util"] }
tokio-test = { version = "0.4.2" }
criterion = { version = "0.3", features = ["async_tokio", "html_reports"] }
pprof = { version = "0.6.1", default-features = false, features = ["flamegraph", "criterion"] }
tempfile = { version = "3.2.0" }
testcontainers = { version = "0.12.0" }
rand = { version = "0.8.4" }
env-test-util = { version = "1.0.1" }
testify = { path = "lib/testify" }
assert_cmd = { version = "2.0.2" }
proptest = { version = "1.0" }
tower-test = { version = "0.4.0" }

[dependencies]
# workspaces
buffers = { path = "lib/buffers" }
event = { path = "lib/event" }
internal = { path = "lib/internal" }
prometheus = { path = "lib/prometheus" }
log_schema = { path = "lib/log_schema" }
tracing-limit = { path = "lib/tracing-limit" }
humanize = { path = "lib/humanize" }
sysinfo = { path = "lib/sysinfo" }

# Allocation
mimalloc = { version = "0.1.27", default-features = false, optional = true }
jemallocator = { version = "0.3.2", default-features = false, optional = true }
jemalloc-sys = { version = "0.3.2", optional = true, features = ["stats", "profiling", "unprefixed_malloc_on_supported_platforms"] }
jemalloc-ctl = { version = "0.3.3", optional = true }

# futrures & tokio
tokio = { version = "1.14.0", features = ["time", "net", "signal", "fs", "rt-multi-thread", "io-util", "process"] }
tokio-stream = { version = "0.1.8", features = ["time"] }
tokio-util = { version = "0.6.9", default-features = false, features = ["codec", "time"] }
bytes = { version = "1.1.0", features = ["serde"] }
futures = { version = "0.3.18" }
futures-util = { version = "0.3.18" }
async-trait = { version = "0.1.51" }
pin-project = { version = "1.0.8" }
stream-cancel = { version = "0.8.1" }
async-stream = { version = "0.3.2" }
console-subscriber = { git = "https://github.com/tokio-rs/console", rev = "f2c30d52c9f22de69bac38009a9183135808806c", optional = true }

# Metrics
metrics = { version = "0.17.0", default-features = false, features = ["std"] }
metrics-tracing-context = { version = "0.8.1", default-features = false }

# Tracing
tracing = { version = "0.1.28", default-features = false }
tracing-core = { version = "0.1.21", default-features = false }
tracing-futures = { version = "0.2.5", default-features = false, features = ["futures-03"] }
tracing-log = { version = "0.1.2", default-features = false, features = ["std", "log-tracer"] }
tracing-subscriber = { version = "0.3.3", default-features = false, features = ["env-filter", "json", "ansi"] }

# HTTP
hyper = { version = "0.14.16", features = ["client", "runtime", "http1", "http2", "server", "stream"] }
hyper-proxy = { version = "0.9.1", default-features = false, features = ["openssl-tls"] }
listenfd = { version = "0.3.5", default-features = false, optional = true }
cidr = { version = "0.2.1" }
no-proxy = { version = "0.3.1" }
http = { version = "0.2.5" }
headers = { version = "0.3.5" }

# Tower
tower = { version = "0.4.10", default-features = false, features = ["buffer", "limit", "retry", "timeout", "util"] }

# Serde
serde = { version = "1.0.131", features = ["derive", "std", "rc"] }
serde_yaml = { version = "0.8.21" }
serde_json = { version = "1.0.72", default-features = false }
serde-xml-rs = { version = "0.5", default-features = false, optional = true }

# Netlink
netlink-sys = { version = "0.7.0", features = ["tokio_socket"], optional = true }
rtnetlink = { version = "0.8.1", features = ["tokio_socket"], optional = true }
netlink-packet-sock-diag = { version = "0.1.0", optional = true }

# Protobuf
prost = { version = "0.9.0", default-features = false, features = ["std"] }
prost-types = { version = "0.9.0", default-features = false }

# TLS
tokio-openssl = { version = "0.6.3", default-features = false }
openssl = { version = "0.10.36", default-features = false }
hyper-openssl = { version = "0.9.1", default-features = false }
openssl-probe = { version = "0.1.4", default-features = false }

# Networking
socket2 = { version = "0.4.2", default-features = false }

# Profile
pprof = { version = "0.6.0", default-features = false, optional = true, features = ["flamegraph", "protobuf"] }

# External libs
chrono = { version = "0.4.19", features = ["serde"] }
chrono-tz = { version = "0.6.1", features = ["serde"] }
dyn-clone = { version = "1.0.4" }
lazy_static = { version = "1.4.0" }
derivative = { version = "2.2.0" }
typetag = { version = "0.1.8" }
indexmap = { version = "1.7.0", default-features = false, features = ["serde"] }
regex = { version = "1.5.4" }
hostname = { version = "0.3.1" }
bloom = { version = "0.3.2" }
exitcode = { version = "1.1.2" }
clap = { version = "3.0.0-beta.5" }
url = { version = "2.2.2", features = ["serde"] }
glob = { version = "0.3.0" }
rdkafka = { version = "0.28.0", default-features = false, optional = true, features = ["tokio", "ssl", "zstd", "libz-static", "sasl"] }
rsntp = { version = "2.1.0", default-features = false, features = ["tokio"], optional = true }
libc = { version = "0.2.110", optional = true }
nom = { version = "7.1.0", default-features = false }
snafu = { version = "0.6.10" }
redis = { version = "0.21.4", default-features = false, optional = true, features = ["tokio-comp", "connection-manager"] }
pulsar = { version = "4.1.1", default-features = false, optional = true, features = ["tokio-runtime", "compression"] }
seahash = { version = "4.1.0", default-features = false, optional = true }
inventory = { version = "0.1.11" }
num_cpus = { version = "1.13.0" }
once_cell = { version = "1.8", default-features = false }
sqlx = { version = "0.5.6", default-features = false, optional = true, features = ["mysql", "runtime-tokio-rustls", "macros"] }
uuid = { version = "0.8", default-features = false, features = ["v4"] }
md5 = { version = "0.7" }
mongodb = { version = "2.0.2", default-features = false, optional = true, features = ["tokio-runtime"] }
rand_distr = { version = "0.4.2", default-features = false }
twox-hash = { version = "1.6.1", default-features = false }
flate2 = { version = "1.0.21" }
percent-encoding = { version = "2.1.0", default-features = false }