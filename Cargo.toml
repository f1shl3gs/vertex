[package]
name = "vertex"
version = "0.1.0"
authors = ["f1shl3gs"]
edition = "2021"
repository = "https://github.com/f1shl3gs/vertex"
publish = false

exclude = [
    "tests/fixtures"
]

# This profile optimizes for runtime performance and small binary size at the expense of longer
# build times. It's most suitable for final release builds.
[profile.release]
debug = false
lto = "thin"

# This profile optimizes for short build times at the expense of larger binary size and slower
# runtime performance.
[profile.dev]
lto = false
incremental = true

[profile.bench]
debug = true

[workspace]
members = [
    "lib/backoff",
    "lib/buffers",
    "lib/codecs",
    "lib/configurable",
    "lib/configurable-derive",
    "lib/condition",
    "lib/event",
    "lib/finalize",
    "lib/framework",
    "lib/multiline",
    "lib/serde_regex",
    "lib/metrics",
    "lib/prometheus",
    "lib/testify",
    "lib/tail",
    "lib/tripwire",
    "lib/log_schema",
    "lib/tracing-limit",
    "lib/sysinfo",
    "lib/virt",
    "lib/jaeger",
    "lib/tracing-internal",
]

[features]
default = [
    "common",

    "extensions",
    "sources",
    "transforms",
    "sinks",

    "extensions-pprof"
]

target-x86_64-unknown-linux-musl = [
    "common",

    "extensions",
    "sinks",
    "sources",
    "transforms",
]

target-x86_64-unknown-linux-gnu = [
    "common",

    "extensions",
    "sinks",
    "sources",
    "transforms",

    "extensions-pprof"
]

common = [
  "disk-buffer"
]

benches = [
    "sources-node_metrics",
    "sources-haproxy",
    "sinks-loki"
]

# Integration tests
all-integration-tests = [
    "integration-tests-consul",
    "integration-tests-elasticsearch",
    "integration-tests-haproxy",
    "integration-tests-kafka",
    "integration-tests-loki",
    "integration-tests-memcached",
    "integration-tests-mysql",
    "integration-tests-nginx_stub",
    "integration-tests-ntp",
    "integration-tests-prometheus_exporter",
    "integration-tests-prometheus_remote_write",
    "integration-tests-prometheus_scrape",
    "integration-tests-redis",
    "integration-tests-zookeeper"
]

integration-tests-clickhouse = []
integration-tests-consul = []
integration-tests-elasticsearch = []
integration-tests-haproxy = []
integration-tests-kafka = []
integration-tests-loki = []
integration-tests-memcached = []
integration-tests-mysql = []
integration-tests-nginx_stub = []
integration-tests-ntp = []
integration-tests-prometheus_exporter = []
integration-tests-prometheus_remote_write = []
integration-tests-prometheus_scrape = []
integration-tests-redis = []
integration-tests-zookeeper = []

# Common
disk-buffer = [
  "dep:buffers"
]
tokio-console = ["framework/tokio-console", "tokio/tracing"]

# Allocator
# mimalloc is an optional dependecy, and the feature `mimalloc` is created by default. So no
# need to declare it again.
jemalloc = ["tikv-jemallocator", "tikv-jemalloc-ctl", "tikv-jemalloc-sys"]

# Extensions
extensions = [
    "extensions-healthcheck",
    "extensions-heartbeat",
    # Musl does not provide "pthread_getname_np" in current release.
    # https://github.com/tikv/pprof-rs/issues/41
    "extensions-pprof",
    "extensions-zpages"
]

extensions-heartbeat = ["uuid", "sysinfo", "parking_lot/serde"]
extensions-healthcheck = []
extensions-jemalloc = ["tikv-jemallocator", "tikv-jemalloc-ctl", "tikv-jemalloc-sys"]
extensions-pprof = ["dep:pprof", "dep:inferno"]
extensions-zpages = []

# Sources
sources = [
    "sources-bind",
    "sources-chrony",
    "sources-consul",
    "sources-clickhouse_metrics",
    "sources-demo_logs",
    "sources-elasticsearch",
    "sources-grpc_check",
    "sources-exec",
    "sources-haproxy",
    "sources-http_check",
    "sources-internal_logs",
    "sources-internal_metrics",
    "sources-internal_traces",
    "sources-jaeger",
    "sources-journald",
    "sources-kafka",
    "sources-kafka_metrics",
    "sources-kmsg",
    "sources-kubernetes_events",
    "sources-kubernetes_logs",
    "sources-libvirt",
    "sources-memcached",
    "sources-mongodb",
    "sources-mysqld",
    "sources-nginx_stub",
    "sources-node_metrics",
    "sources-ntp",
    "sources-nvidia_smi",
    "sources-prometheus_scrape",
    "sources-prometheus_remote_write",
    "sources-pulsar",
    "sources-redis",
    "sources-selfstat",
    "sources-syslog",
    "sources-tail",
    "sources-zookeeper",
]

sources-bind = []
sources-chrony = []
sources-consul = []
sources-demo_logs = []
sources-exec = ["tokio/process"]
sources-clickhouse_metrics = []
sources-elasticsearch = []
sources-grpc_check = ["tonic", "tonic-health"]
sources-haproxy = []
sources-http_check = []
sources-internal_logs = []
sources-internal_metrics = []
sources-internal_traces = ["tracing-subscriber"]
sources-jaeger = ["jaeger", "tonic"]
sources-journald = []
sources-kafka = ["rskafka", "async-stream"]
sources-kafka_metrics = ["rskafka"]
sources-kmsg = []
sources-kubernetes_logs = ["tail", "multiline", "kubernetes", "ahash", "parking_lot"]
sources-kubernetes_events = ["kubernetes"]
sources-libvirt = ["virt"]
sources-memcached = []
sources-mongodb = []
sources-mysqld = ["sqlx"]
sources-nginx_stub = []
sources-node_metrics = ["libc", "netlink-packet-sock-diag", "netlink-sys", "netlink-packet-core"]
sources-ntp = ["rsntp/tokio", "rsntp/async"]
sources-nvidia_smi = ["dep:quick-xml"]
sources-pulsar = []
sources-prometheus_scrape = ["prometheus"]
sources-prometheus_remote_write = ["snap"]
sources-redis = []
sources-selfstat = ["libc"]
sources-syslog = ["codecs/syslog", "sources-utils-tcp-keepalive", "sources-utils-tcp-socket", "smallvec"]
sources-tail = ["tail", "multiline", "encoding_rs"]
sources-zookeeper = []

# transforms
transforms = [
    "transforms-add_tags",
    "transforms-add_fields",
    "transforms-cardinality",
    "transforms-coercer",
    "transforms-dedup",
    "transforms-enum",
    "transforms-filter",
    "transforms-geoip",
    "transforms-json_parser",
    "transforms-metricalize",
    "transforms-route",
    "transforms-sample",
    "transforms-substr",
    "transforms-throttle"
]
transforms-add_tags = []
transforms-add_fields = []
transforms-cardinality = ["bloom"]
transforms-coercer = []
transforms-dedup = ["lru"]
transforms-enum = []
transforms-filter = ["condition"]
transforms-geoip = [ "maxminddb" ]
transforms-json_parser = []
transforms-metricalize = ["async-stream"]
transforms-route = ["condition"]
transforms-sample = ["seahash"]
transforms-substr = []
transforms-throttle = []

# sinks
sinks = [
    "sinks-blackhole",
    "sinks-clickhouse",
    "sinks-console",
    "sinks-elasticsearch",
    "sinks-jaeger",
    "sinks-kafka",
    "sinks-loki",
    "sinks-prometheus_exporter",
    "sinks-prometheus_remote_write",
    "sinks-pulsar",
    "sinks-socket",
    "sinks-vertex",
]

sinks-console = []
sinks-prometheus_exporter = ["flate2"]
sinks-prometheus_remote_write = ["snap"]
sinks-blackhole = []
sinks-kafka = ["rskafka"]
sinks-jaeger = ["jaeger"]
sinks-pulsar = []
sinks-elasticsearch = []
sinks-loki = ["snap", "dep:buffers"]
sinks-vertex = []
sinks-clickhouse = []
sinks-socket = []

# Enables kubernetes dependencies and shared code. Kubernetes-related sources,
# transforms and sinks should depend on this feature.
kubernetes = ["k8s-openapi", "kube"]

# Misc
sources-utils-tcp-keepalive = []
sources-utils-tcp-socket = []

bench = [
    "sinks-loki",
    "sources-haproxy",
    "sources-node_metrics",
]

[[bench]]
name = "loki"
harness = false
path = "benches/loki.rs"

[[bench]]
name = "hwmon_gather"
harness = false
path = "benches/node_source_hwmon.rs"

[[bench]]
name = "haproxy"
harness = false
path = "benches/haproxy.rs"

[target.'cfg(unix)'.dependencies]
nix = { version = "0.26.2", default-features = false }

[build-dependencies]
prost-build = { version = "0.11.9" }

[dev-dependencies]
assert_cmd = { version = "2.0.11" }
base64 = { version = "0.21.0" }
criterion = { version = "0.4.0", default-features = false, features = ["async_tokio"] }
framework = { path = "lib/framework", features = ["test-util"] }
pretty_assertions = { version = "1.3.0" }
rand = { version = "0.8.5" }
serde_path_to_error = { version = "0.1.10" }
tempfile = { version = "3.5.0" }
testcontainers = { version = "0.14.0" }
testify = { path = "lib/testify" }
tokio = { version = "1.28.0", features = ["test-util", "time"] }

[dependencies]
# Workspaces
buffers = { path = "lib/buffers", optional = true }
codecs = { path = "lib/codecs" }
condition = { path = "lib/condition", optional = true }
configurable = { path = "lib/configurable" }
event = { path = "lib/event" }
framework = { path = "lib/framework" }
humanize = { git = "https://github.com/f1shl3gs/humanize", default-features = false, features = ["bytes", "serde"], rev = "bf61d1d7a8cf282ce95017e98bb0b29c4dd0d98a" }
jaeger = { path = "lib/jaeger", optional = true }
log_schema = { path = "lib/log_schema" }
lookup = { path = "lib/lookup" }
multiline = { path = "lib/multiline", optional = true }
prometheus = { path = "lib/prometheus", optional = true }
measurable = { path = "lib/measurable" }
sysinfo = { path = "lib/sysinfo", optional = true }
tail = { path = "lib/tail", optional = true }
tripwire = { path = "lib/tripwire" }
virt = { path = "lib/virt", optional = true }
metrics = { path = "lib/metrics" }

# Allocation
mimalloc = { version = "0.1.37", default-features = false, optional = true }
tikv-jemallocator = { version = "0.5.0", optional = true, features = ["stats", "profiling", "unprefixed_malloc_on_supported_platforms"] }
tikv-jemalloc-ctl = { version = "0.5.0", optional = true, features = ["use_std"] }
tikv-jemalloc-sys = { version = "0.5.3", optional = true, features = ["stats"] }

# Futrures & Tokio
async-stream = { version = "0.3.5", optional = true }
async-trait = { version = "0.1.68" }
futures = { version = "0.3.28", default-features = false }
futures-util = { version = "0.3.27", default-features = false }
pin-project = { version = "1.0.12", default-features = false }
tokio = { version = "1.28.0", features = ["time", "net", "signal", "fs", "rt-multi-thread", "io-util", "process"] }
tokio-stream = { version = "0.1.14", features = ["time", "net", "sync"] }
tokio-util = { version = "0.7.8", default-features = false, features = ["codec", "time", "net"] }

# Tracing
tracing = { version = "0.1.38", default-features = false }
tracing-log = { version = "0.1.3", default-features = false }
tracing-subscriber = { version = "0.3.17", optional = true, default-features = false, features = ["std", "registry"] }

# HTTP
hyper = { version = "0.14.26", features = ["client", "runtime", "http1", "http2", "server", "stream"] }
http = { version = "0.2.9", default-features = false }

# Tower
tower = { version = "0.4.13", default-features = false }

# Serde
serde = { version = "1.0.163", default-features = false, features = ["derive"] }
serde_yaml = { version = "0.9.21" }
serde_json = { version = "1.0.96", default-features = false }
serde_regex = { path = "lib/serde_regex" }

# Netlink
netlink-sys = { version = "0.8.5", features = ["tokio_socket"], optional = true }
netlink-packet-sock-diag = { version = "0.4.1", optional = true }
netlink-packet-core = { version = "0.5.0", optional = true }

# Protobuf
prost = { version = "0.11.9", default-features = false, features = ["std"] }
prost-types = { version = "0.11.9", default-features = false }

# Profile
pprof = { version = "0.11.1", default-features = false, optional = true, features = ["flamegraph", "prost-codec"] }
# pin inferno, so rustc will not warning us for inferno using older quick-xml.
inferno = { version = "0.11.15", default-features = false, features = ["nameattr"], optional = true }

# Cli
argh = { version = "0.1.10" }
colored = { version = "2.0.0", default-features = false }

# External libs
ahash = { version = "0.8.3", optional = true }
# TODO: Remove this, once std::io::IsTerminal merged and stablized.
# See: https://doc.rust-lang.org/std/io/trait.IsTerminal.html#
#      https://github.com/rust-lang/rust/issues/98070#issuecomment-1486375244
atty = { version = "0.2.14", default-features = false }
bloom = { version = "0.3.2", default-features = false, optional = true }
bytes = { version = "1.4.0", default-features = false, features = ["serde"] }
chrono = { version = "0.4.24", default-features = false }
chrono-tz = { version = "0.8.2", default-features = false }
encoding_rs = { version = "0.8.32", optional = true, features = ["serde"] }
exitcode = { version = "1.1.2" }
flate2 = { version = "1.0.26", optional = true }
glob = { version = "0.3.1" }
indexmap = { version = "1.9.3", default-features = false, features = ["serde"] }
inventory = { version = "0.3.5" }
k8s-openapi = { version = "0.18.0", default-features = false, optional = true, features = ["api", "v1_20"] }
kube = { version = "0.82.2", default-features = false, optional = true, features = ["client", "runtime", "rustls-tls"] }
libc = { version = "0.2.144", optional = true }
lru = { version = "0.10.0", default-features = false, optional = true }
maxminddb = { version = "0.23.0", default-features = false, optional = true }
memchr = { version = "2.5.0", optional = true, default-features = false }
# mongodb = { version = "2.1.0", default-features = false, optional = true, features = ["tokio-runtime"] }
nom = { version = "7.1.3", default-features = false }
once_cell = { version = "1.17.1" }
# pulsar = { version = "4.1.1", default-features = false, optional = true, features = ["tokio-runtime", "compression"] }
parking_lot = { version = "0.12.1", default-features = false, optional = true }
percent-encoding = { version = "2.2.0", default-features = false }
quick-xml = { version = "0.28.2", default-features = false, features = ["serialize"], optional = true }
regex = { version = "1.8.1" }
rskafka = { git = "https://github.com/f1shl3gs/rskafka", rev = "95a9f125186593215eba012a61b58bfeea5afb4b", optional = true }
rsntp = { version = "3.0.2", default-features = false, features = ["tokio"], optional = true }
seahash = { version = "4.1.0", default-features = false, optional = true }
smallvec = { version = "1.10.0", optional = true, features = ["union"] }
snap = { version = "1.1.0", default-features = false, optional = true }
sqlx = { version = "0.6.3", default-features = false, optional = true, features = ["mysql", "runtime-tokio-rustls", "macros"] }
thiserror = { version = "1.0.40" }
tonic = { version = "0.9.2", default-features = false, features = ["transport"], optional = true }
tonic-health = { version = "0.9.2", default-features = false, optional = true }
typetag = { version = "0.2.8" }
url = { version = "2.3.1", features = ["serde"] }
uuid = { version = "1.3.2", default-features = false, features = ["v4"], optional = true }
